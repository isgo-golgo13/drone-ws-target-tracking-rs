# =============================================================================
# Drone WebSocket Target Tracking - Docker Compose
# =============================================================================
#
# Usage:
#   make up          # Start services (generates certs if needed)
#   make up-build    # Build and start services
#   make down        # Stop services
#   make logs        # Tail all logs
#
# Manual:
#   docker compose up -d --build
#   docker compose logs -f
#   docker compose down
#

services:
  # ---------------------------------------------------------------------------
  # WebSocket Server (TLS)
  # ---------------------------------------------------------------------------
  ws-server:
    build:
      context: .
      dockerfile: ws-server/Dockerfile
    image: drone-ws-target-tracking-server:latest
    container_name: ws-server
    hostname: ws-server
    restart: unless-stopped
    
    # Non-root user (matches Dockerfile)
    user: "1000:1000"
    
    # Security hardening
    security_opt:
      - no-new-privileges:true
    read_only: true
    
    # Temporary filesystem for runtime needs
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 64M
    
    # Network
    ports:
      - "8443:8443"
    networks:
      - drone-net
    
    # TLS certificates
    volumes:
      - ./certificates:/certificates:ro
    
    # Environment
    environment:
      - RUST_LOG=info,ws_server=debug
      - CERT_PATH=/certificates
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8443 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # WebSocket Client (TLS)
  # ---------------------------------------------------------------------------
  ws-client:
    build:
      context: .
      dockerfile: ws-client/Dockerfile
    image: drone-ws-target-tracking-client:latest
    container_name: ws-client
    hostname: ws-client
    restart: "no"  # One-shot client
    
    # Non-root user (matches Dockerfile)
    user: "1000:1000"
    
    # Security hardening
    security_opt:
      - no-new-privileges:true
    read_only: true
    
    # Temporary filesystem for runtime needs
    tmpfs:
      - /tmp:noexec,nosuid,size=64m
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 32M
    
    # Network
    networks:
      - drone-net
    
    # Wait for server
    depends_on:
      ws-server:
        condition: service_healthy
    
    # TLS certificates
    volumes:
      - ./certificates:/certificates:ro
    
    # Environment - connect to server by service name
    environment:
      - RUST_LOG=info,ws_client=debug
      - CERT_PATH=/certificates
      # Override host to use Docker network DNS
      - WS_HOST=ws-server

  # ---------------------------------------------------------------------------
  # Interactive Client (for manual testing)
  # ---------------------------------------------------------------------------
  ws-client-interactive:
    build:
      context: .
      dockerfile: ws-client/Dockerfile
    image: drone-ws-target-tracking-client:latest
    container_name: ws-client-interactive
    hostname: ws-client-interactive
    
    # Interactive mode
    stdin_open: true
    tty: true
    
    # Non-root user
    user: "1000:1000"
    
    # Security hardening
    security_opt:
      - no-new-privileges:true
    
    # Network
    networks:
      - drone-net
    
    # Wait for server
    depends_on:
      ws-server:
        condition: service_healthy
    
    # TLS certificates
    volumes:
      - ./certificates:/certificates:ro
    
    # Environment
    environment:
      - RUST_LOG=info,ws_client=debug
      - CERT_PATH=/certificates
      - WS_HOST=ws-server
    
    # Override entrypoint for interactive mode
    command: ["./ws-client", "--interactive"]
    
    # Don't start by default
    profiles:
      - interactive

# =============================================================================
# Networks
# =============================================================================
networks:
  drone-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =============================================================================
# Named Volumes (if needed for persistence)
# =============================================================================
# volumes:
#   server-data:
